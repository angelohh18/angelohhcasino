<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - La 51</title>
    <style>
        :root {
            --casino-bg: #3a3a2a;
            --casino-gold: #c5a56a;
            --casino-tan: #e0d3b6;
            --casino-dark-panel: #211e18;
        }
        body, html {
            margin: 0; padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--casino-dark-panel);
            color: var(--casino-tan);
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        h1, h2 {
            color: var(--casino-gold);
            border-bottom: 2px solid var(--casino-gold);
            padding-bottom: 10px;
        }
        .panel {
            background: var(--casino-bg);
            border: 1px solid var(--casino-gold);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        /* admin.html -> dentro de la etiqueta <style> */
        #commission-filters button {
            padding: 8px 12px;
            border: 1px solid var(--casino-gold);
            background-color: transparent;
            color: var(--casino-tan);
            cursor: pointer;
            margin-right: 5px;
        }
        #commission-filters button.active {
            background-color: var(--casino-gold);
            color: var(--casino-bg);
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Panel de Administración</h1>

        <div class="panel">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Ganancias (Comisión 10%)</h2>
                <button id="btn-reset-commissions" style="padding: 5px 10px; background-color: #c0392b; border: none; color: white; border-radius: 4px; cursor: pointer;">Reiniciar Ganancias</button>
            </div>
            <div id="commission-filters" style="margin-bottom: 15px;">
                <button data-period="day">Diario</button>
                <button data-period="week">Semanal</button>
                <button data-period="month">Mensual</button>
                <button data-period="all" class="active">Total</button>
            </div>
            <div id="commission-display">
                <p>Cargando datos...</p>
            </div>
        </div>

    <div class="panel">
        <h2>Resumen Mensual y Semanal</h2>
        <table id="summary-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="padding: 8px; border-bottom: 1px solid var(--casino-gold); text-align: left;">Periodo</th>
                    <th style="padding: 8px; border-bottom: 1px solid var(--casino-gold); text-align: right;">Ganancias</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <div class="panel">
        <h2>Gestionar Tasas de Cambio (referencia: 1 EUR/USD)</h2>
        <div id="exchange-rates-form">
            <label for="rate-eur-cop">1 EUR equivale a COP:</label>
            <input type="number" id="rate-eur-cop" step="0.01">
            <br><br>
            <label for="rate-usd-cop">1 USD equivale a COP:</label>
            <input type="number" id="rate-usd-cop" step="0.01">
            <br><br>
            <label for="rate-eur-usd">1 EUR equivale a USD:</label>
            <input type="number" id="rate-eur-usd" step="0.01">
            <br><br>
            <button id="btn-save-rates">Guardar Tasas</button>
        </div>
    </div>

        <!-- ▼▼▼ PANEL REDISEÑADO DE GESTIÓN DE USUARIOS ▼▼▼ -->
        <div class="panel">
            <h2>Gestionar Usuarios Registrados</h2>

            <select id="user-edit-dropdown" style="width: 100%; padding: 8px; margin-bottom: 15px;">
                <option value="">Selecciona un usuario para gestionar...</option>
            </select>

            <div id="user-edit-form-container" style="display: none; background: var(--casino-dark-panel); padding: 15px; border-radius: 5px;">
                <h3 id="form-username-title" style="margin-top: 0; color: var(--casino-gold);"></h3>

                <h4>Gestión de Créditos</h4>
                <div style="margin-bottom: 10px;">
                    <strong>Saldo Actual:</strong>
                    <span id="current-credits-display" style="font-size: 1.1em; color: var(--casino-gold); font-weight: bold;"></span>
                </div>
                <input type="number" id="edit-credits-input" style="width: 120px; padding: 5px;" placeholder="Nuevo Saldo Total">
                <select id="edit-currency-select" style="padding: 5px;">
                    <option value="EUR">EUR</option>
                    <option value="USD">USD</option>
                    <option value="COP">COP</option>
                </select>
                <button id="btn-save-credits" style="padding: 5px 10px; margin-left: 10px;">Guardar Créditos</button>
                <hr style="border-color: var(--casino-gold); margin: 15px 0;">

                <h4>Reiniciar Contraseña</h4>
                <input type="text" id="edit-password-input" style="padding: 5px;" placeholder="Nueva contraseña (mín. 4 cars.)">
                <button id="btn-update-password" style="padding: 5px 10px; margin-left: 10px;">Actualizar Contraseña</button>
                <hr style="border-color: var(--casino-gold); margin: 15px 0;">

                <h4 style="color: #c0392b;">Zona de Peligro</h4>
                <button id="btn-delete-user" style="padding: 5px 10px; background-color: #c0392b; color: white; border: none;">Eliminar Usuario Permanentemente</button>
            </div>
        </div>
        <!-- ▲▲▲ FIN DEL PANEL REDISEÑADO ▲▲▲ -->

        <!-- ▼▼▼ NUEVO PANEL: DATOS COMPLETOS DE CLIENTES ▼▼▼ -->
        <div class="panel">
            <h2>Datos Completos de Clientes Registrados</h2>
            <select id="user-details-dropdown" style="width: 100%; padding: 8px; margin-bottom: 15px;">
                <option value="">Selecciona un usuario para ver sus detalles...</option>
            </select>
            <pre id="user-details-display" style="background: var(--casino-dark-panel); padding: 15px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word;"></pre>
        </div>
        <!-- ▲▲▲ FIN DEL NUEVO PANEL ▲▲▲ -->
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io(window.location.origin);
        let fullCommissionLog = [];

        const commissionDisplay = document.getElementById('commission-display');
        
        // ... (código existente)
        const eurCopInput = document.getElementById('rate-eur-cop');
        const usdCopInput = document.getElementById('rate-usd-cop');
        const eurUsdInput = document.getElementById('rate-eur-usd'); // <-- NUEVA LÍNEA
        const btnSaveRates = document.getElementById('btn-save-rates');

        socket.on('admin:commissionData', (log) => {
            fullCommissionLog = log || [];
            // Por defecto, mostramos el filtro "Total"
            updateAllDisplays('all');
        });

        function formatCurrency(value) {
            return value.toLocaleString('es-CO', { // Locale colombiano para formato (ej. 1.234.567)
                style: 'currency',
                currency: 'COP', // Moneda a mostrar: Pesos Colombianos
                minimumFractionDigits: 0 // Usualmente COP no usa centavos
            });
        }

        function updateAllDisplays(period) {
            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            startOfWeek.setHours(0, 0, 0, 0);
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            const filteredLog = fullCommissionLog.filter(entry => {
                const entryDate = new Date(entry.timestamp);
                switch (period) {
                    case 'day': return entryDate >= startOfToday;
                    case 'week': return entryDate >= startOfWeek;
                    case 'month': return entryDate >= startOfMonth;
                    case 'all':
                    default: return true;
                }
            });

            const total = filteredLog.reduce((sum, entry) => sum + entry.amount, 0);
            commissionDisplay.innerHTML = `<h3 style="margin: 0; font-size: 2rem; color: #6bff6b;">${formatCurrency(total)}</h3>`;

            // Actualizar la clase activa en los botones de filtro
            document.querySelectorAll('#commission-filters button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === period);
            });
            
            // Renderizar la tabla de resumen
            renderSummaryTable();
        }

        function renderSummaryTable() {
            const tableBody = document.querySelector("#summary-table tbody");
            tableBody.innerHTML = ''; // Limpiar tabla

            if (fullCommissionLog.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="2" style="padding: 8px; text-align: center;">No hay datos de ganancias.</td></tr>';
                return;
            }

            const monthlySummary = {};
            const weeklySummary = {};
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

            fullCommissionLog.forEach(entry => {
                const date = new Date(entry.timestamp);
                const year = date.getFullYear();
                const month = date.getMonth();
                const week = Math.ceil((date.getDate() + 6 - date.getDay()) / 7);

                // Resumen Mensual
                const monthKey = `${year}-${month}`;
                if (!monthlySummary[monthKey]) {
                    monthlySummary[monthKey] = { total: 0, name: `${monthNames[month]} ${year}` };
                }
                monthlySummary[monthKey].total += entry.amount;

                // Resumen Semanal
                const weekKey = `${year}-${month}-${week}`;
                if (!weeklySummary[weekKey]) {
                    weeklySummary[weekKey] = { total: 0, name: `Semana ${week} de ${monthNames[month]}` };
                }
                weeklySummary[weekKey].total += entry.amount;
            });

            // Añadir filas de meses
            Object.values(monthlySummary).forEach(summary => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td style="padding: 8px; font-weight: bold;">${summary.name}</td>
                    <td style="padding: 8px; text-align: right; font-weight: bold;">${formatCurrency(summary.total)}</td>
                `;
            });
            
            // Añadir filas de semanas
            Object.values(weeklySummary).forEach(summary => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td style="padding: 8px; padding-left: 20px;">${summary.name}</td>
                    <td style="padding: 8px; text-align: right;">${formatCurrency(summary.total)}</td>
                `;
            });
        }

        // AÑADE este listener para recibir y mostrar las tasas actuales
        socket.on('admin:exchangeRates', (rates) => {
            if (rates.EUR) {
                eurCopInput.value = rates.EUR.COP;
                eurUsdInput.value = rates.EUR.USD; // <-- NUEVA LÍNEA
            }
            if (rates.USD) usdCopInput.value = rates.USD.COP;
        });

        // AÑADE el listener para el botón de guardar
        btnSaveRates.addEventListener('click', () => {
            const newRates = {
                EUR_COP: parseFloat(eurCopInput.value),
                USD_COP: parseFloat(usdCopInput.value),
                EUR_USD: parseFloat(eurUsdInput.value) // <-- NUEVA LÍNEA
            };
            socket.emit('admin:updateRates', newRates);
            alert('Tasas de cambio enviadas al servidor.');
        });

        socket.on('connect', () => {
            console.log('Conectado al servidor como Admin');
            socket.emit('admin:requestUserList');
            socket.emit('admin:requestRates');
            socket.emit('admin:requestFullUserList'); // <-- SOLICITA LISTA COMPLETA DE USUARIOS
        });

        // La función que renderiza la tabla ahora también asignará los eventos a los botones
        // ▼▼▼ INICIO DEL NUEVO BLOQUE DE CÓDIGO PARA GESTIÓN DE USUARIOS ▼▼▼

        let allUsersData = []; // Guardaremos la lista de usuarios aquí
        const userEditDropdown = document.getElementById('user-edit-dropdown');
        const userEditFormContainer = document.getElementById('user-edit-form-container');

        // 1. Listener que recibe la lista de usuarios y puebla el desplegable
        socket.on('admin:userList', (users) => {
            console.log('Usuarios para gestión recibidos:', users);
            allUsersData = users; // Guardamos los datos

            // Guardamos la selección actual para no perderla al recargar
            const currentSelection = userEditDropdown.value;
            userEditDropdown.innerHTML = '<option value="">Selecciona un usuario para gestionar...</option>'; // Limpiamos

            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.username; // Usamos el username como valor único
                option.textContent = user.username;
                userEditDropdown.appendChild(option);
            });

            // Restauramos la selección si aún existe
            if (currentSelection) {
                userEditDropdown.value = currentSelection;
            }

            // Disparamos el evento 'change' manualmente si hay una selección para recargar el formulario
            if (userEditDropdown.value) {
                userEditDropdown.dispatchEvent(new Event('change'));
            }
        });

        // 2. Listener para cuando se selecciona un usuario en el desplegable
        userEditDropdown.addEventListener('change', () => {
            const selectedUsername = userEditDropdown.value;
            if (!selectedUsername) {
                userEditFormContainer.style.display = 'none'; // Ocultar formulario si no hay selección
                return;
            }

            const selectedUser = allUsersData.find(u => u.username === selectedUsername);
            if (selectedUser) {
                // Rellenar el formulario con los datos del usuario
                document.getElementById('form-username-title').textContent = `Gestionando a: ${selectedUser.username}`;
                
                // ▼▼▼ ACTUALIZA EL SALDO ACTUAL ▼▼▼
                document.getElementById('current-credits-display').textContent = `${selectedUser.credits.toLocaleString('es-ES')} ${selectedUser.currency}`;
                // ▲▲▲ FIN ▲▲▲
                
                document.getElementById('edit-credits-input').value = selectedUser.credits;
                document.getElementById('edit-currency-select').value = selectedUser.currency;
                document.getElementById('edit-password-input').value = ''; // Limpiar campo de contraseña

                // Mostramos el formulario
                userEditFormContainer.style.display = 'block';
            }
        });

        // 3. Listeners para los botones de acción dentro del formulario
        userEditFormContainer.addEventListener('click', (e) => {
            const selectedUsername = userEditDropdown.value;
            if (!selectedUsername) return;

            const selectedUser = allUsersData.find(u => u.username === selectedUsername);
            if (!selectedUser) return;

            // Acción: Guardar Créditos
            if (e.target.id === 'btn-save-credits') {
                const newCredits = document.getElementById('edit-credits-input').value;
                const newCurrency = document.getElementById('edit-currency-select').value;

                if (newCredits !== '' && !isNaN(newCredits)) {
                    e.target.textContent = 'Guardando...';
                    e.target.disabled = true;

                    socket.emit('admin:updateCredits', { 
                        userId: selectedUser.id, // El id es 'user_username'
                        newCredits: parseFloat(newCredits),
                        newCurrency: newCurrency
                    });

                    // Re-habilitamos el botón después de un momento
                    setTimeout(() => {
                        e.target.textContent = 'Guardar Créditos';
                        e.target.disabled = false;
                    }, 1500);
                } else {
                    alert('Por favor, introduce un valor numérico válido para los créditos.');
                }
            }

            // Acción: Actualizar Contraseña
            if (e.target.id === 'btn-update-password') {
                const newPassword = document.getElementById('edit-password-input').value;
                if (!newPassword || newPassword.length < 4) {
                    alert('La contraseña debe tener al menos 4 caracteres.');
                    return;
                }
                if (confirm(`¿Seguro que quieres establecer una NUEVA contraseña para "${selectedUsername}"?`)) {
                    e.target.textContent = 'Actualizando...';
                    e.target.disabled = true;
                    socket.emit('admin:updatePassword', { username: selectedUsername, newPassword });

                     setTimeout(() => {
                        document.getElementById('edit-password-input').value = '';
                        e.target.textContent = 'Actualizar Contraseña';
                        e.target.disabled = false;
                        alert(`Contraseña para ${selectedUsername} actualizada.`);
                    }, 1500);
                }
            }

            // Acción: Eliminar Usuario
            if (e.target.id === 'btn-delete-user') {
                if (confirm(`¿Estás seguro de que quieres eliminar PERMANENTEMENTE al usuario "${selectedUsername}"? Esta acción no se puede deshacer.`)) {
                    e.target.textContent = 'Eliminando...';
                    e.target.disabled = true;
                    socket.emit('admin:deleteUser', { userId: selectedUser.id });
                    // El formulario se ocultará automáticamente cuando la lista de usuarios se actualice
                    userEditFormContainer.style.display = 'none';
                }
            }
        });

        // ▲▲▲ FIN DEL NUEVO BLOQUE DE CÓDIGO ▲▲▲

        document.addEventListener('DOMContentLoaded', () => {
            // Listeners para los filtros de periodo
            const filtersContainer = document.getElementById('commission-filters');
            filtersContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const period = e.target.dataset.period;
                    updateAllDisplays(period);
                }
            });

            // Listener para el botón de reinicio
            const btnReset = document.getElementById('btn-reset-commissions');
            btnReset.addEventListener('click', () => {
                if (confirm('¿Estás seguro de que quieres reiniciar TODAS las ganancias a cero? Esta acción no se puede deshacer.')) {
                    socket.emit('admin:resetCommissions');
                }
            });

            // ▼▼▼ NUEVO: PANEL DE DATOS COMPLETOS DE USUARIOS ▼▼▼
            const userDropdown = document.getElementById('user-details-dropdown');
            const userDisplay = document.getElementById('user-details-display');
            let fullUserList = []; // Para guardar la lista completa

            // 1. Escuchamos la lista completa de usuarios enviada por el servidor
            socket.on('admin:fullUserList', (users) => {
                fullUserList = users; // Guardamos la lista
                userDropdown.innerHTML = '<option value="">Selecciona un usuario para ver sus detalles...</option>'; // Limpiamos y añadimos opción por defecto

                users.forEach((user, index) => {
                    const option = document.createElement('option');
                    option.value = index; // Usamos el índice del array como valor
                    option.textContent = user.username;
                    userDropdown.appendChild(option);
                });
            });

            // 2. Añadimos un listener para cuando se cambie la selección en el dropdown
            userDropdown.addEventListener('change', () => {
                const selectedIndex = userDropdown.value;
                if (selectedIndex === '') {
                    userDisplay.textContent = ''; // Limpiamos el display si no hay nadie seleccionado
                    return;
                }

                const selectedUser = fullUserList[selectedIndex];
                if (selectedUser) {
                    // Formateamos los datos para que se vean bien
                    const userDataFormatted = {
                        ID: selectedUser.id,
                        Usuario: selectedUser.username,
                        Creditos: `${selectedUser.credits} ${selectedUser.currency}`,
                        Pais: selectedUser.country,
                        WhatsApp: selectedUser.whatsapp,
                        AvatarURL: selectedUser.avatar_url,
                        FechaRegistro: new Date(selectedUser.created_at).toLocaleString('es-ES')
                    };
                    // Usamos JSON.stringify para mostrarlo de forma ordenada en la etiqueta <pre>
                    userDisplay.textContent = JSON.stringify(userDataFormatted, null, 2);
                }
            });
            // ▲▲▲ FIN DEL CÓDIGO DE DATOS COMPLETOS ▲▲▲
        });
    </script>
</body>
</html>